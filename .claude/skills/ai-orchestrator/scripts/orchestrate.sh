#!/bin/bash
# AIå¤šå¼•æ“ç¼–æ’è„šæœ¬ - æ ¸å¿ƒå®ç°
# ä½œè€…ï¼šè€é‡‘
# å…¬ä¼—å·ï¼šè€é‡‘å¸¦ä½ ç©AI | å¾®ä¿¡ï¼šxun900207 | å¤‡æ³¨AIåŠ å…¥AIäº¤æµç¾¤
# åŸåˆ™ï¼šKISSï¼ˆç®€å•è‡³ä¸Šï¼‰ã€DRYï¼ˆæœç»é‡å¤ï¼‰ã€é›¶ç ´åæ€§

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼ˆä¿¡ä»»bashçš„é”™è¯¯ä¼ æ’­æœºåˆ¶ï¼‰

# ============================================
# Logoæ˜¾ç¤º
# ============================================
show_logo() {
    echo "=================================================="
    echo "  AIå¤šå¼•æ“ç¼–æ’ç³»ç»Ÿ v1.0"
    echo "  å…¬ä¼—å·ï¼šè€é‡‘å¸¦ä½ ç©AI"
    echo "  å¾®ä¿¡ï¼šxun900207 | å¤‡æ³¨AIåŠ å…¥AIäº¤æµç¾¤"
    echo "=================================================="
    echo ""
}

# ============================================
# å…¨å±€é…ç½®
# ============================================
TASK="${1:-æœªæŒ‡å®šä»»åŠ¡}"
OUTPUT_DIR=".ai-orchestrator"
LOG_FILE="$OUTPUT_DIR/orchestration.log"
RESULT_FILE="$OUTPUT_DIR/result.md"

# ============================================
# å·¥å…·å‡½æ•°
# ============================================

# æ—¥å¿—å‡½æ•°ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
log() {
    local message="$1"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $message" | tee -a "$LOG_FILE"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    local message="$1"
    log "âŒ é”™è¯¯: $message"
    exit 1
}

# æ£€æŸ¥å·¥å…·æ˜¯å¦å®‰è£…
check_tool() {
    local tool="$1"
    local install_guide="$2"

    if ! command -v "$tool" &> /dev/null; then
        log "âš ï¸  æœªæ£€æµ‹åˆ° $tool å·¥å…·"
        log "å®‰è£…æŒ‡å—: $install_guide"
        return 1
    fi
    log "âœ… $tool å·¥å…·å·²å®‰è£…"
    return 0
}

# ============================================
# åˆå§‹åŒ–
# ============================================
init() {
    log "========================================="
    log "ğŸš€ AIå¤šå¼•æ“ç¼–æ’å¼€å§‹"
    log "ä»»åŠ¡: $TASK"
    log "========================================="

    # åˆ›å»ºå·¥ä½œç›®å½•
    mkdir -p "$OUTPUT_DIR"

    # æ£€æŸ¥å¿…è¦å·¥å…·
    log "ğŸ” æ£€æŸ¥å·¥å…·å®‰è£…æƒ…å†µ..."

    if ! check_tool "codex" "npm i -g @openai/codex"; then
        error_exit "Codex CLIæœªå®‰è£…ï¼Œæ— æ³•ç»§ç»­"
    fi

    if ! check_tool "gemini" "npm install -g @google/gemini-cli"; then
        log "âš ï¸  Gemini CLIæœªå®‰è£…ï¼Œå°†è·³è¿‡ä»£ç å®¡æŸ¥é˜¶æ®µ"
    fi
}

# ============================================
# é˜¶æ®µ1ï¼šéœ€æ±‚åˆ†æï¼ˆClaudeè‡ªå·±åšï¼‰
# ============================================
phase1_analyze() {
    log ""
    log "ğŸ“‹ é˜¶æ®µ1: éœ€æ±‚åˆ†æï¼ˆClaudeï¼‰"

    local output_file="$OUTPUT_DIR/phase1_requirements.json"

    # Claudeä¼šæ ¹æ®prompts/phase1-analyze.mdçš„æç¤ºè¯è‡ªå·±åˆ†æ
    # è¿™é‡Œåªæ˜¯æç¤ºClaudeéœ€è¦åšä»€ä¹ˆ
    cat > "$output_file" <<EOF
{
  "task_description": "$TASK",
  "timestamp": "$(date '+%Y-%m-%d %H:%M:%S')",
  "phase": "requirements_analysis",
  "note": "è¯·Claudeæ ¹æ®ä»»åŠ¡æè¿°è¯¦ç»†åˆ†ææŠ€æœ¯éœ€æ±‚ï¼ŒåŒ…å«åŠŸèƒ½æ¸…å•ã€æŠ€æœ¯æ ˆã€æ–‡ä»¶ç»“æ„ã€å…³é”®è¦ç‚¹å’Œé£é™©è¯„ä¼°"
}
EOF

    log "âœ… é˜¶æ®µ1å®Œæˆï¼šéœ€æ±‚åˆ†æå·²å‡†å¤‡"
    log "ğŸ“„ è¾“å‡ºæ–‡ä»¶: $output_file"
}

# ============================================
# é˜¶æ®µ2ï¼šä»£ç ç”Ÿæˆï¼ˆCodexï¼‰
# ============================================
phase2_generate() {
    log ""
    log "ğŸ’» é˜¶æ®µ2: ä»£ç ç”Ÿæˆï¼ˆCodexï¼‰"

    local input_file="$OUTPUT_DIR/phase1_requirements.json"
    local output_file="$OUTPUT_DIR/phase2_code.md"

    if [ ! -f "$input_file" ]; then
        error_exit "æ‰¾ä¸åˆ°é˜¶æ®µ1çš„è¾“å‡ºæ–‡ä»¶: $input_file"
    fi

    log "ğŸ“¤ è°ƒç”¨Codexç”Ÿæˆä»£ç ..."

    # æ„å»ºCodexæç¤ºè¯
    local prompt
    prompt=$(cat <<PROMPT
æ ¹æ®ä»¥ä¸‹æŠ€æœ¯éœ€æ±‚ç”Ÿæˆå®Œæ•´ä»£ç ï¼š

$(cat "$input_file")

è¦æ±‚ï¼š
1. ç”Ÿæˆæ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä»£ç 
2. åŒ…å«è¯¦ç»†çš„ä»£ç æ³¨é‡Š
3. éµå¾ªæœ€ä½³å®è·µå’Œç¼–ç è§„èŒƒ
4. ç¡®ä¿ä»£ç å¯ä»¥ç›´æ¥è¿è¡Œ
5. ä»¥Markdownæ ¼å¼è¾“å‡ºï¼Œæ¯ä¸ªæ–‡ä»¶ç”¨ä»£ç å—æ ‡æ³¨æ–‡ä»¶è·¯å¾„

ä»»åŠ¡æè¿°: $TASK
PROMPT
)

    # è°ƒç”¨Codexï¼ˆé”™è¯¯ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°set -eï¼‰
    if codex exec "$prompt" > "$output_file" 2>> "$LOG_FILE"; then
        log "âœ… é˜¶æ®µ2å®Œæˆï¼šä»£ç å·²ç”Ÿæˆ"
        log "ğŸ“„ è¾“å‡ºæ–‡ä»¶: $output_file"
        log "ğŸ“Š ä»£ç è¡Œæ•°: $(wc -l < "$output_file")"
    else
        error_exit "Codexä»£ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $LOG_FILE"
    fi
}

# ============================================
# é˜¶æ®µ3ï¼šä»£ç å®¡æŸ¥ï¼ˆGeminiï¼‰
# ============================================
phase3_review() {
    log ""
    log "ğŸ” é˜¶æ®µ3: ä»£ç å®¡æŸ¥ï¼ˆGeminiï¼‰"

    local input_file="$OUTPUT_DIR/phase2_code.md"
    local output_file="$OUTPUT_DIR/phase3_review.md"

    # å¦‚æœGeminiæœªå®‰è£…ï¼Œè·³è¿‡è¿™ä¸ªé˜¶æ®µ
    if ! command -v gemini &> /dev/null; then
        log "âš ï¸  Geminiæœªå®‰è£…ï¼Œè·³è¿‡ä»£ç å®¡æŸ¥"
        echo "âš ï¸  Gemini CLIæœªå®‰è£…ï¼Œæ— æ³•è¿›è¡Œä»£ç å®¡æŸ¥" > "$output_file"
        return 0
    fi

    if [ ! -f "$input_file" ]; then
        error_exit "æ‰¾ä¸åˆ°é˜¶æ®µ2çš„è¾“å‡ºæ–‡ä»¶: $input_file"
    fi

    log "ğŸ“¤ è°ƒç”¨Geminiå®¡æŸ¥ä»£ç ..."

    # æ„å»ºGeminiæç¤ºè¯
    local prompt
    prompt=$(cat <<PROMPT
è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å¹¶æä¾›ä¼˜åŒ–å»ºè®®ï¼š

$(cat "$input_file")

å®¡æŸ¥è¦ç‚¹ï¼š
1. ä»£ç è´¨é‡ï¼šæ˜¯å¦ç¬¦åˆæœ€ä½³å®è·µï¼Ÿ
2. å®‰å…¨æ€§ï¼šæ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ï¼Ÿ
3. æ€§èƒ½ï¼šæ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ï¼Ÿ
4. å¯ç»´æŠ¤æ€§ï¼šä»£ç æ˜¯å¦æ˜“äºç†è§£å’Œç»´æŠ¤ï¼Ÿ
5. é”™è¯¯å¤„ç†ï¼šå¼‚å¸¸å¤„ç†æ˜¯å¦å®Œå–„ï¼Ÿ

è¯·ä»¥Markdownæ ¼å¼è¾“å‡ºå®¡æŸ¥æŠ¥å‘Šï¼ŒåŒ…å«ï¼š
- æ€»ä½“è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰
- å‘ç°çš„é—®é¢˜ï¼ˆæŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼‰
- å…·ä½“çš„ä¼˜åŒ–å»ºè®®
- æ”¹è¿›åçš„ä»£ç ç¤ºä¾‹

ä»»åŠ¡æè¿°: $TASK
PROMPT
)

    # è°ƒç”¨Geminiï¼ˆå…è®¸å¤±è´¥ï¼Œå› ä¸ºæ˜¯å¯é€‰åŠŸèƒ½ï¼‰
    if gemini -p "$prompt" > "$output_file" 2>> "$LOG_FILE"; then
        log "âœ… é˜¶æ®µ3å®Œæˆï¼šä»£ç å®¡æŸ¥å·²ç”Ÿæˆ"
        log "ğŸ“„ è¾“å‡ºæ–‡ä»¶: $output_file"
    else
        log "âš ï¸  Geminiå®¡æŸ¥å¤±è´¥ï¼Œä½†ä¸å½±å“æ•´ä½“æµç¨‹"
        echo "âš ï¸  Geminiå®¡æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" > "$output_file"
    fi
}

# ============================================
# é˜¶æ®µ4ï¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
# ============================================
generate_report() {
    log ""
    log "ğŸ“Š ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š..."

    cat > "$RESULT_FILE" <<EOF
# AIå¤šå¼•æ“ç¼–æ’ç»“æœ

**ä»»åŠ¡æè¿°**: $TASK
**å®Œæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**å·¥ä½œç›®å½•**: \`$OUTPUT_DIR\`

---

## é˜¶æ®µ1: éœ€æ±‚åˆ†æï¼ˆClaude Sonnet 4.5ï¼‰

\`\`\`json
$(cat "$OUTPUT_DIR/phase1_requirements.json" 2>/dev/null || echo "{}")
\`\`\`

---

## é˜¶æ®µ2: ä»£ç ç”Ÿæˆï¼ˆGPT-5.1 Codex Maxï¼‰

$(cat "$OUTPUT_DIR/phase2_code.md" 2>/dev/null || echo "ä»£ç ç”Ÿæˆå¤±è´¥")

---

## é˜¶æ®µ3: ä»£ç å®¡æŸ¥ï¼ˆGemini 3 Proï¼‰

$(cat "$OUTPUT_DIR/phase3_review.md" 2>/dev/null || echo "ä»£ç å®¡æŸ¥æœªæ‰§è¡Œ")

---

## æ‰§è¡Œæ€»ç»“

- âœ… **éœ€æ±‚åˆ†æ**: å·²å®Œæˆ
- âœ… **ä»£ç ç”Ÿæˆ**: å·²å®Œæˆ
- $([ -f "$OUTPUT_DIR/phase3_review.md" ] && echo "âœ…" || echo "âš ï¸") **ä»£ç å®¡æŸ¥**: $([ -f "$OUTPUT_DIR/phase3_review.md" ] && echo "å·²å®Œæˆ" || echo "æœªæ‰§è¡Œ")

### ç”Ÿæˆçš„æ–‡ä»¶

\`\`\`bash
$OUTPUT_DIR/
â”œâ”€â”€ phase1_requirements.json  # éœ€æ±‚åˆ†æ
â”œâ”€â”€ phase2_code.md            # ç”Ÿæˆä»£ç 
â”œâ”€â”€ phase3_review.md          # å®¡æŸ¥æŠ¥å‘Š
â”œâ”€â”€ result.md                 # æœ¬æŠ¥å‘Š
â””â”€â”€ orchestration.log         # æ‰§è¡Œæ—¥å¿—
\`\`\`

### ä¸‹ä¸€æ­¥

1. æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç : \`cat $OUTPUT_DIR/phase2_code.md\`
2. æŸ¥çœ‹å®¡æŸ¥æŠ¥å‘Š: \`cat $OUTPUT_DIR/phase3_review.md\`
3. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—: \`cat $LOG_FILE\`

---

**æç¤º**: æ‰€æœ‰ä¸­é—´æ–‡ä»¶å·²ä¿å­˜åˆ° \`$OUTPUT_DIR/\` ç›®å½•ï¼Œå¯éšæ—¶æŸ¥çœ‹è¯¦ç»†è¿‡ç¨‹ã€‚
EOF

    log "âœ… æœ€ç»ˆæŠ¥å‘Šå·²ç”Ÿæˆ: $RESULT_FILE"
}

# ============================================
# ä¸»æµç¨‹
# ============================================
main() {
    # æ˜¾ç¤ºLogo
    show_logo

    # åˆå§‹åŒ–
    init

    # æ‰§è¡Œä¸‰ä¸ªé˜¶æ®µ
    phase1_analyze
    phase2_generate
    phase3_review

    # ç”ŸæˆæŠ¥å‘Š
    generate_report

    log ""
    log "========================================="
    log "ğŸ‰ AIå¤šå¼•æ“ç¼–æ’å®Œæˆï¼"
    log "ğŸ“„ æœ€ç»ˆæŠ¥å‘Š: $RESULT_FILE"
    log "========================================="

    # è‡ªåŠ¨æ‰“å¼€ç»“æœï¼ˆå¦‚æœæœ‰VS Codeï¼‰
    if command -v code &> /dev/null; then
        code "$RESULT_FILE" 2>/dev/null || true
    fi
}

# å¯åŠ¨ä¸»æµç¨‹
main
